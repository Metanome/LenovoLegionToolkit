name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
      channel:
        description: 'Release channel'
        required: true
        default: Stable
        type: choice
        options:
          - Stable
          - Beta
          - Dev
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-2022

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 9.0.x
        cache: true
        cache-dependency-path: '**/*.csproj'
        
    - name: Resolve release metadata
      id: release_meta
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        INPUT_VERSION: ${{ github.event.inputs.version }}
        INPUT_CHANNEL: ${{ github.event.inputs.channel }}
        REF_NAME: ${{ github.ref_name }}
        EVENT_NAME: ${{ github.event_name }}
      run: |
        $channel = "Stable"
        $prerelease = "false"
        $targetCommitish = "master"

        # 1. Determine Channel and Version
        if ($env:EVENT_NAME -eq "workflow_dispatch") {
            $version = $env:INPUT_VERSION
            $channel = $env:INPUT_CHANNEL

            if ($version -notmatch '^\d+\.\d+\.\d+(\.\d+)?$') {
                Write-Error "Invalid version '$version'. Expected format: X.Y.Z or X.Y.Z.W"
                exit 1
            }
            $tagName = "v$version"
        } else {
            # Release publish trigger
            $tagName = "${{ github.event.release.tag_name }}"
            $version = $tagName -replace '^v', ''
            
            # Retrieve release metadata directly from the event payload
            $isPrerelease = "${{ github.event.release.prerelease }}"
            $targetCommitish = "${{ github.event.release.target_commitish }}"

            if ($targetCommitish -eq "dev") {
                $channel = "Dev"
            } elseif ($isPrerelease -eq "true") {
                $channel = "Beta"
            } else {
                $channel = "Stable"
            }
        }

        # 2. Apply your exact branch/release rules
        switch ($channel) {
            "Stable" {
                $prerelease = "false"
                $targetCommitish = "master"
            }
            "Beta" {
                $prerelease = "true"
                $targetCommitish = "master"
            }
            "Dev" {
                $prerelease = "false"
                $targetCommitish = "dev"
            }
            default {
                Write-Error "Unsupported channel: $channel"
                exit 1
            }
        }

        # 3. Output for the Release step
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "channel=$channel" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "prerelease=$prerelease" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "target_commitish=$targetCommitish" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "tag_name=$tagName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      shell: powershell

    - name: Restore
      run: dotnet restore
      
    - name: Build
      run: .\make_action.bat ${{ steps.release_meta.outputs.version }}

    - name: Rename installer
      run: |
        $oldPath = "build_installer\LenovoLegionToolkitSetup.exe"
        $newPath = "build_installer\LenovoLegionToolkitSetup-v${{ steps.release_meta.outputs.version }}.exe"
        
        if (Test-Path $oldPath) {
            Rename-Item -Path $oldPath -NewName (Split-Path $newPath -Leaf)
        } else {
            Write-Error "Build artifact not found at $oldPath"
            exit 1
        }
      shell: powershell
      
    - name: Verify installer
      run: |
        $installerPath = "build_installer\LenovoLegionToolkitSetup-v${{ steps.release_meta.outputs.version }}.exe"
        if (-not (Test-Path $installerPath)) {
          Write-Error "Installer file not found at $installerPath"
          exit 1
        }
      shell: powershell
        
    - name: Update Release (Published)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2.0.8
      with:
        tag_name: ${{ steps.release_meta.outputs.tag_name }}
        target_commitish: ${{ steps.release_meta.outputs.target_commitish }}
        prerelease: ${{ steps.release_meta.outputs.prerelease }}
        name: Lenovo Legion Toolkit v${{ steps.release_meta.outputs.version }} (${{ steps.release_meta.outputs.channel }})
        files: build_installer/LenovoLegionToolkitSetup-v${{ steps.release_meta.outputs.version }}.exe
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Draft Release (Manual)
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2.0.8
      with:
        draft: true
        tag_name: ${{ steps.release_meta.outputs.tag_name }}
        target_commitish: ${{ steps.release_meta.outputs.target_commitish }}
        prerelease: ${{ steps.release_meta.outputs.prerelease }}
        name: Lenovo Legion Toolkit v${{ steps.release_meta.outputs.version }} (${{ steps.release_meta.outputs.channel }})
        body: |
          ## Release Notes
          Version ${{ steps.release_meta.outputs.version }}
          Channel: ${{ steps.release_meta.outputs.channel }}
        files: build_installer/LenovoLegionToolkitSetup-v${{ steps.release_meta.outputs.version }}.exe
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: installer-v${{ steps.release_meta.outputs.version }}-${{ steps.release_meta.outputs.channel }}
        path: build_installer/LenovoLegionToolkitSetup-v${{ steps.release_meta.outputs.version }}.exe